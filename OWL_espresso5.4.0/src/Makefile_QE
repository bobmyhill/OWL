#YingWai's note:
# $(LD) $(LDFLAGS) $(IFLAGS) $(LIBS) are in QE's make.sys
# $(LINKFLAGS) is in OWL's architecture file


QUANTUM_ESPRESSO_ROOT=./qe
include $(QUANTUM_ESPRESSO_ROOT)/make.sys
include make.depend

# location of needed modules and included files (if any)
MODFLAGS= $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/iotk/src \
          $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/FFTXlib  \
          $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/LAXlib   \
          $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/Modules  \
          $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/PW/src $(MOD_FLAG).
#IFLAGS=

#location of needed libraries
LIBOBJS= $(QUANTUM_ESPRESSO_ROOT)/iotk/src/libiotk.a $(QUANTUM_ESPRESSO_ROOT)/clib/clib.a

QEMODS=$(QUANTUM_ESPRESSO_ROOT)/Modules/libqemod.a $(QUANTUM_ESPRESSO_ROOT)/FFTXlib/libqefft.a $(QUANTUM_ESPRESSO_ROOT)/LAXlib/libqela.a
PWOBJS= $(QUANTUM_ESPRESSO_ROOT)/PW/src/libpw.a

#TLDEPS=bindir mods libs liblapack libblas pw


QE_OBJS =                   \
QuantumEspressoSystem.o     \
QEMCMoves.o

OWLLIBS = \
owl_getInfo_pwscf.o         \
owl_do_pwscf.o              \
owl_run_QE.o




default: owl-qe

all : owl-qe

owl-qe : $(QE_OBJS) libowl.a
	$(LD) $(LDFLAGS) $(LINKFLAGS) $(FFLAGS_NOMAIN) -o $@ $(BASIC_OWL_OBJS) $(QE_OBJS) libowl.a $(PWOBJS) $(QEMODS) $(LIBOBJS) -L/opt/intel/compilers_and_libraries_2018.1.163/linux/mkl/lib/intel64_lin $(LIBS)

# TODO: Remove the MKL library link from above
# -L/opt/intel/compilers_and_libraries_2018.1.163/linux/mkl/lib/intel64_lin

clean:
	rm -rf *.o *.a *.dSYM

%.o : %.cpp
	$(CXX) $(CXXFLAGS) $(INCLUDE_PATH) -c -o $@ $<

#%.o: %.f
#       $(F77) $(FFLAGS) -c $< -o $@
libowl.a : $(OWLLIBS)
	$(AR) $(ARFLAGS) $@ $?
	$(RANLIB) $@

