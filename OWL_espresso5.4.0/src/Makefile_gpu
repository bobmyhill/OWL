# Makefile for OWL

QUANTUM_ESPRESSO_ROOT=./qe_gpu
include $(QUANTUM_ESPRESSO_ROOT)/make.sys

EXECUTABLE = owl_gpu

### Define C++ compiler and flags for different machines
include architecture/olcf_titan
#include architecture/olcf_eos
#include architecture/nersc
#include architecture/mac_osx

.SUFFIXES :
.SUFFIXES : .o .c .f .f90 .cpp

.cpp.o:
	$(CXX) $(CXXFLAGS)  -c $<

# location of needed modules and included files (if any)
MODFLAGS= $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/iotk/src \
	  $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/FFTXlib  \
          $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/LAXlib   \
	  $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/Modules  \
	  $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/GPU/Modules  \
	  $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/GPU/PW \
	  $(MOD_FLAG)$(QUANTUM_ESPRESSO_ROOT)/PW/src $(MOD_FLAG).
IFLAGS=

#location of needed libraries
LIBOBJS= $(QUANTUM_ESPRESSO_ROOT)/iotk/src/libiotk.a $(QUANTUM_ESPRESSO_ROOT)/clib/clib.a

COMMLIBS = \
Communications.o

OWLOBJS = \
QuantumEspressoSystem.o   \
Heisenberg2D.o            \
Ising2D.o                 \
OWLMain.o

OWLLIBS = \
owl_getInfo_pwscf.o       \
owl_do_pwscf.o            \
owl_run_QE.o

MCOBJS = \
Histogram.o                 \
RandomNumberGenerator.o     \
MCAlgorithms.o              \
WangLandauSampling.o        \
ReplicaExchangeWangLandau.o \
MulticanonicalSampling.o    \
HistogramFreeMUCA.o         \
MCMoves.o

IOOBJS = \
InputOutput.o


#For linking to the GPU QE
QEMODS=$(QUANTUM_ESPRESSO_ROOT)/GPU/Modules/libqemodgpu.a $(QUANTUM_ESPRESSO_ROOT)/Modules/libqemod.a $(QUANTUM_ESPRESSO_ROOT)/FFTXlib/libqefft.a $(QUANTUM_ESPRESSO_ROOT)/LAXlib/libqela.a
PWOBJS=$(QUANTUM_ESPRESSO_ROOT)/PW/src/libpw.a $(QUANTUM_ESPRESSO_ROOT)/GPU/PW/libpwgpu.a 

TLDEPS=bindir mods libs liblapack libblas
TLDEPS_GPU=gpu-mods pw-gpu

all : tldeps tldeps_gpu $(EXECUTABLE)


$(EXECUTABLE) : libcomm.a $(OWLOBJS) $(MCOBJS) libowl.a $(IOOBJS) $(LIBOBJS) $(PWOBJS) $(QEMODS)
	$(LD) $(LDFLAGS) $(LINKFLAGS) -o $@ \
	$(OWLOBJS) $(MCOBJS) libowl.a libcomm.a $(IOOBJS) $(PWOBJS) $(QEMODS) $(LIBOBJS) $(LIBS)
	- ( cd $(QUANTUM_ESPRESSO_ROOT)/bin; ln -fs $(CURDIR)/$@ . )

libcomm.a : $(COMMLIBS) 
	$(AR) $(ARFLAGS) $@ $?

libowl.a : $(OWLLIBS)
	$(AR) $(ARFLAGS) $@ $?
	$(RANLIB) $@

tldeps :
	if test -n "$(TLDEPS)" ; then \
	( cd $(QUANTUM_ESPRESSO_ROOT) ; $(MAKE) $(TLDEPS) || exit 1 ) ; fi

tldeps_gpu :
	if test -n "$(TLDEPS_GPU)" ; then \
	( cd $(QUANTUM_ESPRESSO_ROOT) ; $(MAKE) -f Makefile.gpu $(TLDEPS_GPU) || exit 1 ) ; fi

clean :
	- /bin/rm -f *.x *.o *.a *~ *.F90 *.d *.mod *.i *.L $(EXECUTABLE)
	- /bin/rm -f $(QUANTUM_ESPRESSO_ROOT)/bin/$(EXECUTABLE)

veryclean :
	- /bin/rm -f *.x *.o *.a *~ *.F90 *.d *.mod *.i *.L *.cpp *.hpp $(EXECUTABLE)
	- /bin/rm -f $(QUANTUM_ESPRESSO_ROOT)/bin/$(EXECUTABLE)

include make.depend
#include make.depend.gpu
